<script>
  const API_URL = "https://wordguesser-jr27.onrender.com";
  const guessesContainer = document.getElementById('guessesContainer');
  const resultDiv = document.getElementById('result');
  const wordInput = document.getElementById('wordInput');
  const modeSelect = document.getElementById('modeSelect');
  let allGuesses = [];

  function createGuessRow(word, editable = true) {
    const row = document.createElement('div');
    row.className = 'guess-row';

    const guess = [];

    for (let i = 0; i < 5; i++) {
      const letter = word[i] || '';
      const div = document.createElement('div');
      div.className = 'letter gray';
      div.textContent = letter;
      div.dataset.index = i;
      div.dataset.state = 'gray';

      if (editable) {
        div.addEventListener('click', () => {
          const next = {
            gray: 'yellow',
            yellow: 'green',
            green: 'gray'
          };
          div.classList.remove(div.dataset.state);
          div.dataset.state = next[div.dataset.state];
          div.classList.add(div.dataset.state);
          guess[i].state = div.dataset.state;
        });
      }

      guess.push({ letter, state: 'gray', div });
      row.appendChild(div);
    }

    guessesContainer.appendChild(row);
    allGuesses.push(guess);
  }

  function addGuess() {
    const word = wordInput.value.toUpperCase();
    if (word.length !== 5) {
      alert("Please enter a 5-letter word.");
      return;
    }
    wordInput.value = '';
    createGuessRow(word);
  }

  async function submitGuesses() {
    const includedCounts = {};
    const excluded = new Set();
    const correct_positions = {};
    const wrong_positions = {};
    const language = document.getElementById('languageSelect').value;
    const mode = modeSelect.value;

    allGuesses.forEach((guess) => {
      guess.forEach((entry, i) => {
        const { letter, state } = entry;
        if (state === 'gray') {
          const isUsedElsewhere = allGuesses.some(g =>
            g.some((e, idx) => e.letter === letter && (e.state === 'green' || e.state === 'yellow'))
          );
          if (!isUsedElsewhere) excluded.add(letter);
        }
        if (state === 'yellow') {
          includedCounts[letter] = (includedCounts[letter] || 0) + 1;
          wrong_positions[i] = wrong_positions[i] || [];
          wrong_positions[i].push(letter);
        }
        if (state === 'green') {
          includedCounts[letter] = (includedCounts[letter] || 0) + 1;
          correct_positions[i] = letter;
        }
      });
    });

    const included = Object.entries(includedCounts)
      .map(([letter, count]) => letter.repeat(count))
      .join('');

    const payload = {
      included,
      excluded: Array.from(excluded).join(''),
      correct_positions,
      wrong_positions,
      language
    };

    const res = await fetch(`${API_URL}/filter`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.count === 0) {
      resultDiv.innerHTML = `<p>No matching words found.</p>`;
      return;
    }

    const topWord = data.top_words.length > 0 ? data.top_words[0] : 'â€”';
    resultDiv.innerHTML = `
      <h2>ðŸ§  Recommended Next Word: <span style="color:#6aaa64">${topWord}</span></h2>
      <p>Found <b>${data.count}</b> possible words.</p>
      <details>
        <summary>Show all matches</summary>
        <ul>${data.all_scored.map(([w, s]) => `<li>${w} (${s})</li>`).join('')}</ul>
      </details>
    `;

    createGuessRow(topWord); // Auto-add next guess row

    if (mode === 'vsMachine' && allGuesses.length === 6) {
      const lastGuess = allGuesses[5];
      const allGreen = lastGuess.every(entry => entry.state === 'green');
      if (!allGreen) {
        const message = language === 'catalan' ? 'Felicitats Ferran' : 'Congrats you won';
        alert(message);
      }
    }
  }

  document.getElementById('submitBtn').addEventListener('click', submitGuesses);

  modeSelect.addEventListener('change', () => {
    const mode = modeSelect.value;
    if (mode === 'vsMachine') {
      wordInput.style.display = 'none';
      document.querySelector('button[onclick="addGuess()"]').style.display = 'none';
      allGuesses = [];
      guessesContainer.innerHTML = '';
      resultDiv.innerHTML = '';
      submitGuesses(); // auto-start
    } else {
      wordInput.style.display = '';
      document.querySelector('button[onclick="addGuess()"]').style.display = '';
      allGuesses = [];
      guessesContainer.innerHTML = '';
      resultDiv.innerHTML = '';
    }
  });
</script>
