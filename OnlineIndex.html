<script>
  const API_URL = "https://wordguesser-jr27.onrender.com"; // âœ… Backend URL

  const guessesContainer = document.getElementById('guessesContainer');
  const resultDiv = document.getElementById('result');
  let allGuesses = [];

  function createGuessRow(word, editable = true) {
    const row = document.createElement('div');
    row.className = 'guess-row';

    const guess = [];

    for (let i = 0; i < 5; i++) {
      const letter = word[i] || '';
      const div = document.createElement('div');
      div.className = 'letter gray';
      div.textContent = letter;
      div.dataset.index = i;
      div.dataset.state = 'gray';

      if (editable) {
        div.addEventListener('click', () => {
          const next = {
            gray: 'yellow',
            yellow: 'green',
            green: 'gray'
          };
          div.classList.remove(div.dataset.state);
          div.dataset.state = next[div.dataset.state];
          div.classList.add(div.dataset.state);
          guess[i].state = div.dataset.state;
        });
      }

      guess.push({ letter, state: 'gray', div });
      row.appendChild(div);
    }

    guessesContainer.appendChild(row);
    allGuesses.push(guess);
  }

  function addGuess() {
    const word = document.getElementById('wordInput').value.toUpperCase();
    if (word.length !== 5) {
      alert("Please enter a 5-letter word.");
      return;
    }
    document.getElementById('wordInput').value = '';
    createGuessRow(word);
  }

  document.getElementById('submitBtn').addEventListener('click', async () => {
    const included = new Set();
    const excluded = new Set();
    const correct_positions = {};
    const wrong_positions = {};
    const language = document.getElementById('languageSelect').value;

    allGuesses.forEach((guess) => {
      guess.forEach((entry, i) => {
        const { letter, state } = entry;
        if (state === 'gray') {
          const isUsedElsewhere = allGuesses.some(g =>
            g.some((e, idx) => e.letter === letter && (e.state === 'green' || e.state === 'yellow'))
          );
          if (!isUsedElsewhere) excluded.add(letter);
        }
        if (state === 'yellow') {
          included.add(letter);
          wrong_positions[i] = wrong_positions[i] || [];
          wrong_positions[i].push(letter);
        }
        if (state === 'green') {
          included.add(letter);
          correct_positions[i] = letter;
        }
      });
    });

    const payload = {
      included: Array.from(included).join(''),
      excluded: Array.from(excluded).join(''),
      correct_positions,
      wrong_positions,
      language
    };

    try {
      const res = await fetch(`${API_URL}/filter`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (data.count === 0) {
        resultDiv.innerHTML = `<p>No matching words found.</p>`;
      } else {
        const topWord = data.top_words.length > 0 ? data.top_words[0] : 'â€”';
        resultDiv.innerHTML = `
          <h2>ðŸ§  Recommended Next Word: <span style="color:#6aaa64">${topWord}</span></h2>
          <p>Found <b>${data.count}</b> possible words.</p>
          <details>
            <summary>Show all matches</summary>
            <ul>${data.all_scored.map(([w, s]) => `<li>${w} (${s})</li>`).join('')}</ul>
          </details>
        `;
        createGuessRow(topWord); // Auto-add next guess row
      }
    } catch (error) {
      console.error("Error communicating with backend:", error);
      resultDiv.innerHTML = `<p style="color:red;">Failed to connect to server.</p>`;
    }
  });
</script>
